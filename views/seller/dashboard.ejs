<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Seller Dashboard</title>
  <%- include('../partials/mobile-styles') %>
</head>
<body>
  <div class="container">
    <%- include('../partials/seller-nav') %>

    <h1>Seller Dashboard</h1>
    <% if (typeof maintenance !== 'undefined' && maintenance) { %><p class="success">Maintenance mode <%= maintenance %></p><% } %>
    <% if (typeof reset !== 'undefined' && reset === 'done') { %><p class="success">Cycle reset complete</p><% } %>
    <% if (typeof settings !== 'undefined' && settings === 'saved') { %><p class="success">Settings saved</p><% } %>
    <% if (typeof accepted !== 'undefined' && accepted) { %><p class="success">Payment accepted</p><% } %>
    <% if (typeof rejected !== 'undefined' && rejected) { %><p class="success">Payment rejected</p><% } %>
    <% if (typeof blocked !== 'undefined' && blocked) { %><p class="success">User blocked</p><% } %>
    <% if (typeof err !== 'undefined' && err === 'credits') { %><p class="error">Insufficient credits</p><% } %>

    <div class="card">
      <h2>Overview</h2>
      <div class="stats">
        <div class="stat"><span class="val"><%= seller.credits_balance %></span><br><span class="lbl">Credits</span></div>
        <div class="stat"><span class="val"><%= seller.ccpu %></span><br><span class="lbl">CCPU</span></div>
        <div class="stat"><span class="val"><%= seller.maintenance_mode ? 'ON' : 'OFF' %></span><br><span class="lbl">Maintenance</span></div>
      </div>
      <p style="margin:0.5rem 0;font-size:0.9rem;"><strong>Connect URL:</strong> <code>/connect/<%= seller.slug %>/</code></p>
      <div class="btn-group">
        <form method="post" action="/panel/seller/maintenance" style="flex:1;min-width:0;">
          <input type="hidden" name="enabled" value="<%= seller.maintenance_mode ? 0 : 1 %>">
          <button type="submit" class="btn btn-block <%= seller.maintenance_mode ? 'btn-success' : 'btn-danger' %>"><%= seller.maintenance_mode ? 'Turn OFF Maintenance' : 'Turn ON Maintenance' %></button>
        </form>
        <a href="/panel/seller/reset" class="btn btn-danger btn-block" style="flex:1;min-width:0;">Reset Cycle</a>
      </div>
    </div>

    <div class="card">
      <h2>Settings</h2>
      <form method="post" action="/panel/seller/settings">
        <div class="form-group">
          <label>Telegram Username</label>
          <input type="text" name="telegram_username" value="<%= seller.telegram_username || '' %>" placeholder="@username">
        </div>
        <div class="form-group">
          <label>Private Group Link</label>
          <input type="text" name="private_group_link" value="<%= seller.private_group_link || '' %>" placeholder="https://t.me/joinchat/...">
          <span class="label" style="font-size:0.75rem;">Invite link sent to users with their key. Create link with "Request admin approval" enabled. Add bot as admin with "Approve join requests" and "Ban users".</span>
        </div>
        <div class="form-group">
          <label>Private Group Chat ID</label>
          <input type="text" name="private_group_chat_id" value="<%= seller.private_group_chat_id || '' %>" placeholder="-1001234567890">
          <span class="label" style="font-size:0.75rem;">Required for auto-approve and expiry kick. Get from @RawDataBot in the group.</span>
        </div>
        <div class="form-group">
          <label>Query Group Link</label>
          <input type="text" name="query_group_link" value="<%= seller.query_group_link || '' %>" placeholder="@groupname or https://t.me/groupname or -1001234567890">
          <span class="label" style="font-size:0.75rem;">For paid user queries. Bot must be in the group. Private groups: use numeric chat id.</span>
        </div>
        <button type="submit" class="btn btn-block">Save</button>
      </form>
    </div>

    <div class="card">
      <h2>Pending Payments</h2>
      <% if (pendingPayments && pendingPayments.length) { %>
        <% pendingPayments.forEach(function(p) { %>
        <div class="row-card">
          <div class="value"><strong>@<%= p.telegram_username || p.telegram_user_id %></strong> · <%= p.plan_name %></div>
          <div class="label">UTR: <%= p.utr || '-' %> · Attempts: <%= p.attempts %></div>
          <div class="btn-group">
            <form action="/api/payment/<%= p.id %>/accept" method="post"><button type="submit" class="btn btn-success">Accept</button></form>
            <form action="/api/payment/<%= p.id %>/reject" method="post"><button type="submit" class="btn">Reject</button></form>
            <form action="/api/payment/<%= p.id %>/block" method="post"><button type="submit" class="btn btn-danger">Block</button></form>
          </div>
        </div>
        <% }); %>
      <% } else { %><p>No pending payments</p><% } %>
    </div>

    <div class="card">
      <h2>Recent Subscriptions</h2>
      <% if (subscriptions && subscriptions.length) { %>
        <% subscriptions.forEach(function(s) { %>
        <div class="row-card">
          <div class="value">@<%= s.telegram_username || '-' %></div>
          <div class="label">Key: <code><%= s.key %></code></div>
          <div class="label">Expires: <%= s.expires_at %></div>
        </div>
        <% }); %>
      <% } else { %><p>No subscriptions yet</p><% } %>
    </div>
  </div>
</body>
</html>
